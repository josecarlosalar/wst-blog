---
import { getCollection } from 'astro:content';
import '../styles/global.css';

const allPosts = await getCollection('blog');
const posts = allPosts.sort(
  (a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime(),
);

const categoryFilter = Astro.url.searchParams.get('category') ?? '';

const filteredPosts = categoryFilter
  ? posts.filter((p) => p.data.category === categoryFilter)
  : posts;

const categoryLabels: Record<string, string> = {
  'historia-internet-ia': 'Historia & IA',
  'marketing-digital': 'Marketing Digital',
  'tecnologia-web': 'Tecnología Web',
  'estrategia-empresarial': 'Estrategia Empresarial',
};

const categories = [...new Set(posts.map((p) => p.data.category))];
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog — WebsitesTechnology</title>
    <meta
      name="description"
      content="Artículos sobre SEO, marketing digital, tecnología web y estrategia empresarial."
    />
    <link rel="canonical" href={Astro.site?.toString()} />
  </head>
  <body>
    <nav class="modern-navbar">
      <div class="navbar-wrapper">
        <a href="https://websitestechnology.com" class="logo-container-nav">
          <img src="/logo-color.png" alt="WebsitesTechnology" class="logo-image" />
        </a>
        <div class="nav-links-desktop">
          <a href="https://websitestechnology.com" class="nav-link-item">Inicio</a>
          <a href="/" class="nav-link-item nav-active">Blog</a>
          <a href="https://websitestechnology.com" class="nav-link-item">Servicios</a>
        </div>
        <div class="nav-actions-desktop">
          <a href="https://websitestechnology.com/app" class="btn-contact">Ir a la App</a>
        </div>
      </div>
    </nav>

    <main class="blog-index">
      <div class="blog-index__header">
        <div class="hero-logo">
          <div class="logo-container">
            <div class="logo-glow"></div>
            <img src="/icono-logo.png" alt="WebsitesTechnology" class="animated-logo" />
          </div>
        </div>
        <h1 class="blog-index__title">Blog</h1>
        <p class="blog-index__subtitle">
          Artículos sobre SEO, marketing digital y tecnología web
        </p>

        <div class="blog-index__categories">
          <a href="/" class:list={['category-pill', { active: !categoryFilter }]}>Todos</a>
          {
            categories.map((cat) => (
              <a
                href={`/?category=${cat}`}
                class:list={['category-pill', { active: categoryFilter === cat }]}
              >
                {categoryLabels[cat] ?? cat}
              </a>
            ))
          }
        </div>
      </div>

      {
        filteredPosts.length === 0 ? (
          <div
            style="max-width: 1280px; margin: 0 auto; text-align: center; padding: 4rem 0; color: var(--text-dark-muted);"
          >
            No hay artículos en esta categoría.
          </div>
        ) : (
          <div class="blog-grid">
            {filteredPosts.map((post) => {
              const slug = post.data.slug ?? post.id.split('/').pop()!.replace(/\.md$/, '');
              return (
              <a
                href={`/${post.data.category}/${slug}`}
                class="post-card"
              >
                <span class="post-card__category">
                  {categoryLabels[post.data.category] ?? post.data.category}
                </span>
                <h2 class="post-card__title">{post.data.title}</h2>
                <p class="post-card__description">{post.data.metaDescription}</p>
                <time class="post-card__date" datetime={post.data.publishedAt}>
                  {new Date(post.data.publishedAt).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </time>
                <span class="post-card__arrow" aria-hidden="true">→</span>
              </a>
              );
            })}
          </div>
        )
      }
    </main>

    <footer class="modern-footer">
      <div class="footer-wrapper">
        <div class="footer-bottom-bar">
          <div class="footer-bottom-content">
            <p class="footer-copyright-text">© {new Date().getFullYear()} WebsitesTechnology. Todos los derechos reservados.</p>
            <nav class="footer-legal-links">
              <a href="/politica-privacidad" class="footer-legal-link">Privacidad</a>
              <a href="/politica-cookies" class="footer-legal-link">Cookies</a>
              <a href="/terminos-servicio" class="footer-legal-link">Términos</a>
              <a href="/aviso-legal" class="footer-legal-link">Aviso Legal</a>
            </nav>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
